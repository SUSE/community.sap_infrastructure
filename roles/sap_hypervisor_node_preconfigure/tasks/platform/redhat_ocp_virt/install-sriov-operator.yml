---
- name: Create the SR-IOV Operator namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: openshift-sriov-network-operator

- name: Create the SR-IOV Operator namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: sriov-network-operators
        namespace: openshift-sriov-network-operator
      spec:
        targetNamespaces:
          - openshift-sriov-network-operator

- name: Create the SR-IOV Operator namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: sriov-network-operator-subscription
        namespace: openshift-sriov-network-operator
      spec:
        source: redhat-operators
        sourceNamespace: openshift-marketplace
        name: sriov-network-operator
        channel: "stable"

- name: Pause to give operator a chance to install
  ansible.builtin.pause:
    minutes: 3

- name: Enable unsupported NICs for SR-IOV usage
  when: sap_hypervisor_node_preconfigure_sriov_enable_unsupported_nics
  kubernetes.core.k8s:
    state: patched
    definition:
      apiVersion: sriovnetwork.openshift.io/v1
      kind: SriovOperatorConfig
      spec:
        enableOperatorWebhook: false
